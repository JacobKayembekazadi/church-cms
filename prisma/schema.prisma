// Church Management System Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(STAFF)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?
  
  // Relations
  createdMembers Member[]  @relation("CreatedMembers")
  transactions  Transaction[]
  events        Event[]     @relation("CreatedEvents")
  documents     Document[]
  auditLogs     AuditLog[]
}

enum UserRole {
  ADMIN
  PASTOR
  STAFF
  DEPARTMENT_HEAD
}

// Member Profiles
model Member {
  id            String    @id @default(cuid())
  firstName     String
  lastName      String
  email         String?   @unique
  phone         String?
  dateOfBirth   DateTime?
  gender        Gender?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?
  joinDate      DateTime  @default(now())
  membershipType MembershipType @default(REGULAR)
  status        MemberStatus @default(ACTIVE)
  photo         String?
  emergencyContact String?
  emergencyPhone String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdById   String
  
  // Relations
  createdBy     User      @relation("CreatedMembers", fields: [createdById], references: [id])
  attendances   Attendance[]
  donations     Donation[]
  departmentMembers DepartmentMember[]
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MembershipType {
  VISITOR
  REGULAR
  BAPTIZED
  PARTNER
  LEADERSHIP
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  TRANSFERRED
}

// Attendance Tracking
model Event {
  id          String    @id @default(cuid())
  name        String
  type        EventType
  date        DateTime
  startTime   String?
  endTime     String?
  location    String?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String
  
  // Relations
  createdBy   User      @relation("CreatedEvents", fields: [createdById], references: [id])
  attendances Attendance[]
  offerings   Offering[]
}

enum EventType {
  SUNDAY_SERVICE
  MIDWEEK_SERVICE
  PRAYER_MEETING
  BIBLE_STUDY
  YOUTH_SERVICE
  CHILDREN_SERVICE
  SPECIAL_EVENT
  CONFERENCE
  RETREAT
  OUTREACH
  OTHER
}

model Attendance {
  id          String    @id @default(cuid())
  eventId     String
  memberId    String
  checkInTime DateTime  @default(now())
  notes       String?
  
  // Relations
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member      Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, memberId])
}

// Finance Management
model Transaction {
  id          String    @id @default(cuid())
  date        DateTime  @default(now())
  type        TransactionType
  category    String
  amount      Float
  description String?
  reference   String?
  recordedBy  String
  createdAt   DateTime  @default(now())
  
  // Relations
  user        User      @relation(fields: [recordedBy], references: [id])
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Offering {
  id          String    @id @default(cuid())
  eventId     String
  offeringType OfferingType
  amount      Float
  currency    String    @default("USD")
  notes       String?
  recordedAt  DateTime  @default(now())
  
  // Relations
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

enum OfferingType {
  TITHES
  OFFERINGS
  SPECIAL_OFFERING
  MISSIONS
  BUILDING_FUND
  OTHER
}

model Donation {
  id          String    @id @default(cuid())
  memberId    String?
  donorName   String?
  amount      Float
  currency    String    @default("USD")
  purpose     String?
  date        DateTime  @default(now())
  method      PaymentMethod
  reference   String?
  isAnonymous Boolean   @default(false)
  notes       String?
  
  // Relations
  member      Member?   @relation(fields: [memberId], references: [id], onDelete: SetNull)
}

enum PaymentMethod {
  CASH
  CHECK
  CREDIT_CARD
  BANK_TRANSFER
  MOBILE_MONEY
  ONLINE
  OTHER
}

// Department Management
model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  headId      String?
  type        DepartmentType
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  members     DepartmentMember[]
  records     DepartmentRecord[]
}

enum DepartmentType {
  ADMINISTRATION
  EVANGELISM
  USHERING
  MEDIA
  WORSHIP
  CHILDREN
  YOUTH
  PRAYER
  WELFARE
  SECURITY
  FINANCE
  OTHER
}

model DepartmentMember {
  id           String    @id @default(cuid())
  departmentId String
  memberId     String
  role         String?
  joinedDate   DateTime  @default(now())
  isActive     Boolean   @default(true)
  
  // Relations
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  member       Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([departmentId, memberId])
}

model DepartmentRecord {
  id           String    @id @default(cuid())
  departmentId String
  title        String
  description  String?
  recordType   String
  data         Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
}

// Document Management
model Document {
  id          String    @id @default(cuid())
  name        String
  description String?
  fileUrl     String
  fileType    String
  fileSize    Int
  category    DocumentCategory
  uploadedById String
  tags        String[]
  isPublic    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  uploadedBy  User      @relation(fields: [uploadedById], references: [id])
}

enum DocumentCategory {
  POLICY
  PROCEDURE
  REPORT
  FORM
  MINUTES
  PRESENTATION
  FINANCIAL
  LEGAL
  OTHER
}

// Audit Log
model AuditLog {
  id          String    @id @default(cuid())
  userId      String
  action      String
  entity      String
  entityId    String?
  details     Json?
  ipAddress   String?
  createdAt   DateTime  @default(now())
  
  // Relations
  user        User      @relation(fields: [userId], references: [id])
}
